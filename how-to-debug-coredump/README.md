# 调试coredump

## example

demo.c将会导致程序段错误产生coredump，这里我使用arm-cortexa9_neon-linux-gnueabihf。

## 编译

这里使用`-g`编译会产生`debug-symbols`， 注意`-g`不会影响任何优化选项，`debug-symbols`可以在任何`-O`下生成。
其他的选项是为了强调使用`DWARF`，从而显式地关闭unwind方式。

```
[root@sc how-to-debug-coredump]# arm-cortexa9_neon-linux-gnueabihf-gcc -g -o demo -fomit-frame-pointer -fno-unwind-tables -fno-asynchronous-unwind-tables demo.c
```

编译完成以后，可以执行命令观察`section`是否生成
```
[root@sc how-to-debug-coredump]# arm-cortexa9_neon-linux-gnueabihf-readelf -S demo
There are 35 section headers, starting at offset 0xc68:

Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
......
  [26] .debug_aranges    PROGBITS        00000000 000737 000020 00      0   0  1
  [27] .debug_info       PROGBITS        00000000 000757 000134 00      0   0  1
  [28] .debug_abbrev     PROGBITS        00000000 00088b 0000a8 00      0   0  1
  [29] .debug_line       PROGBITS        00000000 000933 000055 00      0   0  1
  [30] .debug_frame      PROGBITS        00000000 000988 000060 00      0   0  4
  [31] .debug_str        PROGBITS        00000000 0009e8 00013d 01  MS  0   0  1
  [32] .shstrtab         STRTAB          00000000 000b25 000140 00      0   0  1
  [33] .symtab           SYMTAB          00000000 0011e0 0006d0 10     34  82  4
  [34] .strtab           STRTAB          00000000 0018b0 0002a6 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings)
  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)
```

## 分离调试信息

一般来说产品并不会提供带有`debug-symbols`的`binary`，所以这里将`debug-symbols``strip`掉
```
[root@sc how-to-debug-coredump]# arm-cortexa9_neon-linux-gnueabihf-objcopy --only-keep-debug demo demo.dbg
[root@sc how-to-debug-coredump]# arm-cortexa9_neon-linux-gnueabihf-objcopy --strip-debug demo
[root@sc how-to-debug-coredump]# arm-cortexa9_neon-linux-gnueabihf-objcopy --add-gnu-debuglink=demo.dbg demo
```

执行完成后，可以看到`binary`的文件尺寸变小了
```
[root@sc how-to-debug-coredump]# ls -hl demo
-rwxr-xr-x 1 root root 6.9K May  9 17:19 demo
......
[root@sc how-to-debug-coredump]# ls -hl demo
-rwxr-xr-x 1 root root 5.5K May  9 17:29 demo
```

同时可以看到新增了`debug_link`用来对应被分离的调试信息文件
```
[root@sc how-to-debug-coredump]# arm-cortexa9_neon-linux-gnueabihf-objdump -s -j .gnu_debuglink demo

demo:     file format elf32-littlearm

Contents of section .gnu_debuglink:
 0000 64656d6f 2e646267 00000000 ad5f0c4c  demo.dbg....._.L
```
关于`gnu_debuglink`：<https://sourceware.org/gdb/onlinedocs/gdb/Separate-Debug-Files.html>


## 配置目标环境


首先要对目标环境进行，让其能够生成`coredump`，
这些操作可以使能`coredump`生成，同时保证`coredump`与运行`binary`时的目录一致
```
[root@sc ~]# ulimit -c unlimited
[root@sc ~]# echo core > /proc/sys/kernel/core_pattern
```

## 触发段错误

```
[root@sc ~]# ./demo
Segmentation fault (core dumped)
[root@sc ~]# ls core*
core
```

## GDB调试

这里是简单操作`gdb`以及简单显示`backtrace`的例子
```
[root@sc how-to-debug-coredump]# arm-cortexa9_neon-linux-gnueabihf-gdb
GNU gdb (crosstool-NG crosstool-ng-1.22.0) 7.10
Copyright (C) 2015 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "--host=x86_64-build_pc-linux-gnu --target=arm-cortexa9_neon-linux-gnueabihf".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
<http://www.gnu.org/software/gdb/documentation/>.
For help, type "help".
Type "apropos word" to search for commands related to "word".
(gdb) file demo
Reading symbols from demo...Reading symbols from /opt/share/note/how-to-debug-coredump/demo.dbg...done.
done.
(gdb) core core 
warning: exec file is newer than core file.
[New LWP 768]
warning: Could not load shared library symbols for linux-vdso.so.1.
Do you need "set solib-search-path" or "set sysroot"?
Core was generated by `./demo'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x00008404 in myabs (a=0xbea2d000) at demo.c:5
5		if (*a < 0)
(gdb) bt
#0  0x00008404 in myabs (a=0xbea2d000) at demo.c:5
#1  0x00008470 in sum_abs (a=0xbea2ccd0, n=1000000) at demo.c:15
#2  0x000084e8 in main () at demo.c:24
(gdb) 
```

还有一个问题是如何去加载动态库，一般是使用`set solib-search-path`或者`set sysroot`去寻找
```
(gdb) set sysroot /opt/development/qemu-project/rootfs
Reading symbols from /opt/development/qemu-project/rootfs/lib/libc.so.6...done.
Reading symbols from /opt/development/qemu-project/rootfs/lib/ld-linux-armhf.so.3...done.
(gdb) info sharedlibrary
From        To          Syms Read   Shared Object Library
                        No          linux-vdso.so.1
0xb6e5de00  0xb6f4e6a0  Yes         /opt/development/qemu-project/rootfs/lib/libc.so.6
0xb6f7c800  0xb6f97d00  Yes         /opt/development/qemu-project/rootfs/lib/ld-linux-armhf.so.3
(*): Shared library is missing debugging information.
```

当然我这里的动态库没有将`debug-symbols`与`shared-library`分离。
如果分离的话，情况会更加复杂一些，需要像之前处理`binary`一样，使用`set debug-file-directory`加载调试信息文件
